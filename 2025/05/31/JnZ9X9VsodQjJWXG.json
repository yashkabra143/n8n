{"nodes":[{"parameters":{"pollTimes":{"item":[{"mode":"everyMinute"}]},"filters":{"labelIds":["Label_2711911149558664797"],"readStatus":"unread"}},"id":"3ef00fe3-ab6c-4dcf-a48c-d896f1b7c572","name":"Gmail Trigger","type":"n8n-nodes-base.gmailTrigger","typeVersion":1,"position":[-1340,-640],"credentials":{"gmailOAuth2":{"id":"XrwBYBoaTlsy2dGw","name":"Gmail account"}}},{"parameters":{"resource":"message","operation":"get","messageId":"={{$json[\"id\"]}}","additionalFields":{"format":"full"}},"id":"0b68b3c5-3921-44a8-9e6e-bbae58840623","name":"Get Email Body","type":"n8n-nodes-base.gmail","typeVersion":1,"position":[-1140,-640],"credentials":{"gmailOAuth2":{"id":"XrwBYBoaTlsy2dGw","name":"Gmail account"}}},{"parameters":{"jsCode":"// Enhanced email parsing with better error handling\nconst item = $json;\n\n// Extract headers safely\nconst headers = item.payload?.headers || [];\nconst getHeader = (name) => headers.find(h => h.name.toLowerCase() === name.toLowerCase())?.value || '';\n\nconst subject = getHeader('subject') || item.subject || 'No Subject';\nconst fromEmail = getHeader('from') || 'Unknown sender';\nconst toEmail = getHeader('to') || 'Unknown recipient';\nconst date = getHeader('date') || new Date().toISOString();\n\n// Extract body content with better handling\nlet body = '';\nlet htmlBody = '';\n\nfunction extractBodyFromPayload(payload) {\n  if (payload.body?.data) {\n    const decoded = Buffer.from(payload.body.data, 'base64').toString('utf-8');\n    if (payload.mimeType === 'text/plain') {\n      return { text: decoded, html: '' };\n    } else if (payload.mimeType === 'text/html') {\n      return { text: '', html: decoded };\n    }\n  }\n  \n  if (payload.parts) {\n    let textContent = '';\n    let htmlContent = '';\n    \n    for (const part of payload.parts) {\n      if (part.mimeType === 'text/plain' && part.body?.data) {\n        textContent += Buffer.from(part.body.data, 'base64').toString('utf-8');\n      } else if (part.mimeType === 'text/html' && part.body?.data) {\n        htmlContent += Buffer.from(part.body.data, 'base64').toString('utf-8');\n      } else if (part.parts) {\n        // Recursive for nested parts\n        const nested = extractBodyFromPayload(part);\n        textContent += nested.text;\n        htmlContent += nested.html;\n      }\n    }\n    \n    return { text: textContent, html: htmlContent };\n  }\n  \n  return { text: '', html: '' };\n}\n\nconst bodyContent = extractBodyFromPayload(item.payload);\nbody = bodyContent.text || bodyContent.html;\nhtmlBody = bodyContent.html;\n\n// Convert HTML to plain text if needed\nif (!bodyContent.text && bodyContent.html) {\n  body = bodyContent.html\n    .replace(/<br\\s*\\/?>/gi, '\\n')\n    .replace(/<\\/p>/gi, '\\n\\n')\n    .replace(/<[^>]+>/g, '')\n    .replace(/&nbsp;/g, ' ')\n    .replace(/&amp;/g, '&')\n    .replace(/&lt;/g, '<')\n    .replace(/&gt;/g, '>')\n    .replace(/&quot;/g, '\"')\n    .replace(/&#39;/g, \"'\")\n    .replace(/\\s+/g, ' ')\n    .trim();\n}\n\n// Extract Upwork-specific links\nconst upworkLinks = {\n  proposal: body.match(/https:\\/\\/www\\.upwork\\.com\\/ab\\/proposals[^\\s]+/g) || [],\n  job: body.match(/https:\\/\\/www\\.upwork\\.com\\/jobs[^\\s]+/g) || [],\n  contract: body.match(/https:\\/\\/www\\.upwork\\.com\\/ab\\/contracts[^\\s]+/g) || [],\n  freelancer: body.match(/https:\\/\\/www\\.upwork\\.com\\/freelancers[^\\s]+/g) || []\n};\n\nreturn [{\n  messageId: item.id,\n  threadId: item.threadId,\n  from: fromEmail,\n  to: toEmail,\n  subject: subject,\n  body: body,\n  htmlBody: htmlBody,\n  date: date,\n  upworkLinks: upworkLinks,\n  rawPayload: item.payload // Keep for debugging\n}];"},"id":"287ff35c-77c3-4d0c-9945-f1d4b79e2483","name":"Parse Email Content","type":"n8n-nodes-base.code","typeVersion":2,"position":[-920,-640]},{"parameters":{"modelId":{"__rl":true,"value":"gpt-3.5-turbo","mode":"list"},"messages":{"values":[{"content":"=Analyze this Upwork email and classify it into ONE of these categories:\n\n1. **Job Invitation** - Client invited you to submit a proposal\n2. **Interview Request** - Client wants to interview you for a job\n3. **Contract Started** - A new contract has begun\n4. **Contract Ended** - A contract has been completed or terminated\n5. **Payment Notification** - Payment received or earnings update\n6. **Client Message** - Direct message from a client\n7. **Proposal Submitted** - Confirmation of proposal submission\n8. **Profile View** - Someone viewed your profile\n9. **Promotional** - Marketing content from Upwork\n10. **Other** - Anything else\n\nEmail Subject: {{$json[\"subject\"]}}\nEmail Body Preview: {{$json[\"body\"].substring(0, 500)}}...\n\nRespond with ONLY the category name (e.g., \"Job Invitation\")."}]},"options":{"temperature":0.1}},"id":"84f586e8-8ee2-45ad-b656-37bcc1389a86","name":"Classify Email","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1,"position":[-740,-640],"credentials":{"openAiApi":{"id":"Dqcfush3u5R5rndN","name":"OpenAi account"}}},{"parameters":{"jsCode":"// Enhanced data extraction based on email classification\nconst emailData = $items(\"Parse Email Content\")[0].json;\nconst category = $items(\"Classify Email\")[0].json.message.content.trim();\nconst body = emailData.body;\nconst subject = emailData.subject;\nconst upworkLinks = emailData.upworkLinks;\n\nlet extractedData = {\n  classification: category,\n  priority: 'Medium',\n  actionRequired: false,\n  extractedInfo: {},\n  relevantLinks: [],\n  summary: ''\n};\n\n// Category-specific data extraction\nswitch (category) {\n  case \"Job Invitation\":\n    extractedData.priority = 'High';\n    extractedData.actionRequired = true;\n    extractedData.relevantLinks = upworkLinks.proposal.concat(upworkLinks.job);\n    \n    // Extract job details\n    const budgetMatch = body.match(/\\$([\\d,]+(?:\\.\\d{2})?)/g);\n    const skillsMatch = body.match(/Skills?:\\s*([^\\n\\r]+)/i);\n    const timelineMatch = body.match(/(\\d+)\\s*(day|week|month)s?/i);\n    \n    extractedData.extractedInfo = {\n      budget: budgetMatch ? budgetMatch[0] : 'Not specified',\n      skills: skillsMatch ? skillsMatch[1].trim() : 'Not specified',\n      timeline: timelineMatch ? timelineMatch[0] : 'Not specified'\n    };\n    extractedData.summary = `New job invitation - Budget: ${extractedData.extractedInfo.budget}`;\n    break;\n    \n  case \"Interview Request\":\n    extractedData.priority = 'High';\n    extractedData.actionRequired = true;\n    extractedData.relevantLinks = upworkLinks.proposal;\n    \n    const clientMatch = body.match(/([A-Z][a-z]+\\s+[A-Z][a-z]+)\\s+would like to interview you/i);\n    extractedData.extractedInfo = {\n      clientName: clientMatch ? clientMatch[1] : 'Not specified'\n    };\n    extractedData.summary = `Interview request from ${extractedData.extractedInfo.clientName}`;\n    break;\n    \n  case \"Payment Notification\":\n    extractedData.priority = 'Medium';\n    extractedData.actionRequired = false;\n    \n    const earningsMatch = body.match(/\\$([\\d,]+(?:\\.\\d{2})?)/g);\n    const paymentTypeMatch = body.match(/(bonus|milestone|hourly|fixed)/i);\n    \n    extractedData.extractedInfo = {\n      amount: earningsMatch ? earningsMatch[0] : 'Not specified',\n      type: paymentTypeMatch ? paymentTypeMatch[1] : 'Not specified'\n    };\n    extractedData.summary = `Payment received: ${extractedData.extractedInfo.amount}`;\n    break;\n    \n  case \"Contract Started\":\n    extractedData.priority = 'High';\n    extractedData.actionRequired = true;\n    extractedData.relevantLinks = upworkLinks.contract;\n    \n    const contractTitleMatch = subject.match(/\"([^\"]+)\"/); // Extract title from quotes\n    extractedData.extractedInfo = {\n      contractTitle: contractTitleMatch ? contractTitleMatch[1] : 'Not specified'\n    };\n    extractedData.summary = `New contract started: ${extractedData.extractedInfo.contractTitle}`;\n    break;\n    \n  case \"Contract Ended\":\n    extractedData.priority = 'Medium';\n    extractedData.actionRequired = false;\n    extractedData.relevantLinks = upworkLinks.contract;\n    \n    const endedTitleMatch = subject.match(/\"([^\"]+)\"/); \n    extractedData.extractedInfo = {\n      contractTitle: endedTitleMatch ? endedTitleMatch[1] : 'Not specified'\n    };\n    extractedData.summary = `Contract ended: ${extractedData.extractedInfo.contractTitle}`;\n    break;\n    \n  case \"Client Message\":\n    extractedData.priority = 'High';\n    extractedData.actionRequired = true;\n    \n    const messagePreview = body.substring(0, 100).trim();\n    extractedData.extractedInfo = {\n      preview: messagePreview + (body.length > 100 ? '...' : '')\n    };\n    extractedData.summary = `New client message: ${extractedData.extractedInfo.preview}`;\n    break;\n    \n  case \"Proposal Submitted\":\n    extractedData.priority = 'Low';\n    extractedData.actionRequired = false;\n    extractedData.summary = 'Proposal submission confirmed';\n    break;\n    \n  case \"Profile View\":\n    extractedData.priority = 'Low';\n    extractedData.actionRequired = false;\n    extractedData.summary = 'Someone viewed your profile';\n    break;\n    \n  case \"Promotional\":\n    extractedData.priority = 'Low';\n    extractedData.actionRequired = false;\n    extractedData.summary = 'Promotional content from Upwork';\n    break;\n    \n  default:\n    extractedData.priority = 'Low';\n    extractedData.summary = 'Other Upwork notification';\n}\n\n// Add metadata\nextractedData.processedAt = new Date().toISOString();\nextractedData.emailMetadata = {\n  messageId: emailData.messageId,\n  threadId: emailData.threadId,\n  from: emailData.from,\n  subject: emailData.subject,\n  date: emailData.date\n};\n\nreturn [extractedData];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-360,-640],"id":"ed06dbd3-2479-4b08-a315-fa3294b798d3","name":"Extract Details"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"","rightValue":"","operator":{"type":"string","operation":"equals"},"id":"6d3e4fb5-b9c1-4da8-94d1-de671af34901"}],"combinator":"and"}}]},"options":{}},"id":"59bce40f-ddd9-4897-be9d-2a7910095e43","name":"Priority Check","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-1400,-1100],"disabled":true},{"parameters":{"resource":"message","operation":"addLabels"},"id":"9815cad2-dbe2-400b-a618-403e08b62510","name":"Mark as Processed","type":"n8n-nodes-base.gmail","typeVersion":1,"position":[-1200,-940],"credentials":{"gmailOAuth2":{"id":"XrwBYBoaTlsy2dGw","name":"Gmail account"}},"disabled":true},{"parameters":{"authentication":"webhook","content":"=Upwork Message:{{ $json.classification }}","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[-1140,-1100],"id":"c13a5f31-0956-452e-9379-ebec22e0c9c8","name":"Discord","webhookId":"340d8d4b-c147-4e37-8ca8-fb1994e3990c","credentials":{"discordWebhookApi":{"id":"ikkG6F3P64LXDYW4","name":"Discord Webhook account"}},"disabled":true},{"parameters":{"resource":"message","operation":"addLabels"},"id":"b8e4174c-3494-4557-90c3-2c63cf3f136d","name":"Mark as Low Priority","type":"n8n-nodes-base.gmail","typeVersion":1,"position":[1140,640],"credentials":{"gmailOAuth2":{"id":"XrwBYBoaTlsy2dGw","name":"Gmail account"}},"disabled":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.subject }}","rightValue":"urgent","operator":{"type":"string","operation":"contains"},"id":"6d3e4fb5-b9c1-4da8-94d1-de671af34901"},{"leftValue":"={{ $json.subject }}","rightValue":"priority","operator":{"type":"string","operation":"contains"},"id":"7e4f5gc6-c0d2-5eb9-a5e2-ef782bg45012"},{"leftValue":"={{ $json.body }}","rightValue":"interview","operator":{"type":"string","operation":"contains"},"id":"8f5g6hd7-d1e3-6fca-b6f3-fg893ch56123"},{"leftValue":"={{ $json.body }}","rightValue":"hired","operator":{"type":"string","operation":"contains"},"id":"9g6h7ie8-e2f4-7gdb-c7g4-gh904di67234"},{"leftValue":"={{ $json.body }}","rightValue":"proposal accepted","operator":{"type":"string","operation":"contains"},"id":"ah7i8jf9-f3g5-8hec-d8h5-hi015ej78345"}],"combinator":"or"}}]},"options":{}},"id":"2d459c5a-ad45-4530-9c70-8fb6e7558608","name":"Priority Check1","type":"n8n-nodes-base.switch","typeVersion":3,"position":[920,400],"alwaysOutputData":true,"disabled":true},{"parameters":{"resource":"message","operation":"addLabels"},"id":"79e329bf-03a4-4988-bda6-6f1a106cd6ad","name":"Mark as Processed1","type":"n8n-nodes-base.gmail","typeVersion":1,"position":[1140,440],"credentials":{"gmailOAuth2":{"id":"XrwBYBoaTlsy2dGw","name":"Gmail account"}},"disabled":true},{"parameters":{"authentication":"webhook","content":"=ðŸš¨ **High Priority Upwork Message** ðŸš¨\n\n**From:** {{ $json.from || 'Unknown Sender' }}\n**Subject:** {{ $json.subject || 'No Subject' }}\n**Classification:** {{ $json.classification || 'Unclassified' }}\n**Received:** {{ $json.date || 'Unknown Date' }}\n\n**Message Preview:**\n{{ $json.body ? $json.body.substring(0, 300) + '...' : 'No content available' }}\n\n**Action Required:** Please check your Upwork inbox immediately!\n\n---\n*Auto-generated by n8n workflow*","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[800,200],"id":"1be58181-cb23-4ea7-873c-d6c71a509e9c","name":"Discord1","webhookId":"340d8d4b-c147-4e37-8ca8-fb1994e3990c","credentials":{"discordWebhookApi":{"id":"xurjSE5kPTNzxT3j","name":"Discord Webhook account 2"}},"disabled":true},{"parameters":{"resource":"message","operation":"addLabels"},"id":"52a49831-3e9f-4443-bd46-b6a2018423c6","name":"Mark as High Priority","type":"n8n-nodes-base.gmail","typeVersion":1,"position":[-20,20],"credentials":{"gmailOAuth2":{"id":"XrwBYBoaTlsy2dGw","name":"Gmail account"}}},{"parameters":{"authentication":"webhook","content":"=ðŸš¨ **HIGH PRIORITY UPWORK ALERT** ðŸš¨\n\n**ðŸ“§ Email Details:**\nâ€¢ **From:** {{ $json.emailMetadata.from || 'Unknown Sender' }}\nâ€¢ **Subject:** {{ $json.emailMetadata.subject || 'No Subject' }}\nâ€¢ **Date:** {{ $json.emailMetadata.date || 'Unknown Date' }}\n\n**ðŸ·ï¸ Classification:** {{ $json.classification || 'Unclassified' }}\n**âš¡ Priority:** {{ $json.priority || 'Unknown' }}\n**ðŸ“‹ Summary:** {{ $json.summary || 'No summary available' }}\n\n**ðŸ“„ Message Preview:**\n{{ $json.emailMetadata.bodyPreview || 'No content available' }}\n\n{{ $json.extractedInfo && Object.keys($json.extractedInfo).length > 0 ? '**ðŸ“Š Extracted Details:**\\n' + Object.entries($json.extractedInfo).map(([key, value]) => `â€¢ **${key.charAt(0).toUpperCase() + key.slice(1)}:** ${value}`).join('\\n') + '\\n' : '' }}\n{{ $json.relevantLinks && $json.relevantLinks.length > 0 ? '**ðŸ”— Relevant Links:**\\n' + $json.relevantLinks.slice(0, 3).map(link => `â€¢ ${link}`).join('\\n') + '\\n' : '' }}\n\n**âš ï¸ Action Required:** {{ $json.actionRequired ? 'YES - Please check immediately!' : 'NO' }}\n\n---\n*ðŸ“… Processed at: {{ $json.processedAt || 'Unknown time' }}*\n*ðŸ¤– Auto-generated by n8n workflow*","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[0,200],"id":"3653f3ba-61ec-4691-b46f-7313433f1ece","name":"High Priority Discord Alert","webhookId":"340d8d4b-c147-4e37-8ca8-fb1994e3990c","credentials":{"discordWebhookApi":{"id":"xurjSE5kPTNzxT3j","name":"Discord Webhook account 2"}}},{"parameters":{"authentication":"webhook","content":"=ðŸ“¬ **Upwork Notification**\n\n**Classification:** {{ $json.classification || 'Unclassified' }}\n**Summary:** {{ $json.summary || 'No summary available' }}\n**Subject:** {{ $json.emailMetadata.subject || 'No Subject' }}\n**From:** {{ $json.emailMetadata.from || 'Unknown Sender' }}\n\n*Low priority - no immediate action required*\n\n---\n*Processed: {{ $json.processedAt || 'Unknown time' }}*","options":{}},"type":"n8n-nodes-base.discord","typeVersion":2,"position":[0,560],"id":"a7a19ea4-767f-4ec3-a0f8-7c03d29f4cea","name":"Low Priority Discord Summary","webhookId":"340d8d4b-c147-4e37-8ca8-fb1994e3990c","credentials":{"discordWebhookApi":{"id":"xurjSE5kPTNzxT3j","name":"Discord Webhook account 2"}}},{"parameters":{"pollTimes":{"item":[{"mode":"everyMinute"}]},"filters":{"labelIds":["Label_2711911149558664797"],"readStatus":"unread"}},"id":"7579e4bc-3ace-4cf7-9440-5ea016c8005a","name":"Gmail Trigger1","type":"n8n-nodes-base.gmailTrigger","typeVersion":1,"position":[-1580,180],"credentials":{"gmailOAuth2":{"id":"XrwBYBoaTlsy2dGw","name":"Gmail account"}}},{"parameters":{"resource":"message","operation":"get","messageId":"={{$json[\"id\"]}}","additionalFields":{"format":"full"}},"id":"2040d51b-0aad-4079-b086-b88512fb0024","name":"Get Email Body1","type":"n8n-nodes-base.gmail","typeVersion":1,"position":[-1380,180],"credentials":{"gmailOAuth2":{"id":"XrwBYBoaTlsy2dGw","name":"Gmail account"}}},{"parameters":{"jsCode":"// Enhanced email parsing with better error handling\nconst item = $json;\n\n// Extract headers safely\nconst headers = item.payload?.headers || [];\nconst getHeader = (name) => headers.find(h => h.name.toLowerCase() === name.toLowerCase())?.value || '';\n\nconst subject = getHeader('subject') || item.subject || 'No Subject';\nconst fromEmail = getHeader('from') || 'Unknown sender';\nconst toEmail = getHeader('to') || 'Unknown recipient';\nconst date = getHeader('date') || new Date().toISOString();\n\n// Extract body content with better handling\nlet body = '';\nlet htmlBody = '';\n\nfunction extractBodyFromPayload(payload) {\n  if (payload.body?.data) {\n    const decoded = Buffer.from(payload.body.data, 'base64').toString('utf-8');\n    if (payload.mimeType === 'text/plain') {\n      return { text: decoded, html: '' };\n    } else if (payload.mimeType === 'text/html') {\n      return { text: '', html: decoded };\n    }\n  }\n  \n  if (payload.parts) {\n    let textContent = '';\n    let htmlContent = '';\n    \n    for (const part of payload.parts) {\n      if (part.mimeType === 'text/plain' && part.body?.data) {\n        textContent += Buffer.from(part.body.data, 'base64').toString('utf-8');\n      } else if (part.mimeType === 'text/html' && part.body?.data) {\n        htmlContent += Buffer.from(part.body.data, 'base64').toString('utf-8');\n      } else if (part.parts) {\n        // Recursive for nested parts\n        const nested = extractBodyFromPayload(part);\n        textContent += nested.text;\n        htmlContent += nested.html;\n      }\n    }\n    \n    return { text: textContent, html: htmlContent };\n  }\n  \n  return { text: '', html: '' };\n}\n\nconst bodyContent = extractBodyFromPayload(item.payload);\nbody = bodyContent.text || bodyContent.html;\nhtmlBody = bodyContent.html;\n\n// Convert HTML to plain text if needed\nif (!bodyContent.text && bodyContent.html) {\n  body = bodyContent.html\n    .replace(/<br\\s*\\/?>/gi, '\\n')\n    .replace(/<\\/p>/gi, '\\n\\n')\n    .replace(/<[^>]+>/g, '')\n    .replace(/&nbsp;/g, ' ')\n    .replace(/&amp;/g, '&')\n    .replace(/&lt;/g, '<')\n    .replace(/&gt;/g, '>')\n    .replace(/&quot;/g, '\"')\n    .replace(/&#39;/g, \"'\")\n    .replace(/\\s+/g, ' ')\n    .trim();\n}\n\n// Extract Upwork-specific links\nconst upworkLinks = {\n  proposal: body.match(/https:\\/\\/www\\.upwork\\.com\\/ab\\/proposals[^\\s]+/g) || [],\n  job: body.match(/https:\\/\\/www\\.upwork\\.com\\/jobs[^\\s]+/g) || [],\n  contract: body.match(/https:\\/\\/www\\.upwork\\.com\\/ab\\/contracts[^\\s]+/g) || [],\n  freelancer: body.match(/https:\\/\\/www\\.upwork\\.com\\/freelancers[^\\s]+/g) || []\n};\n\nreturn [{\n  messageId: item.id,\n  threadId: item.threadId,\n  from: fromEmail,\n  to: toEmail,\n  subject: subject,\n  body: body,\n  htmlBody: htmlBody,\n  date: date,\n  upworkLinks: upworkLinks,\n  rawPayload: item.payload // Keep for debugging\n}];"},"id":"b5f7090f-6241-4cd1-b2fb-33cdccb16b0e","name":"Parse Email Content1","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1160,180]},{"parameters":{"modelId":{"__rl":true,"value":"gpt-3.5-turbo","mode":"list","cachedResultName":"GPT-3.5-TURBO"},"messages":{"values":[{"content":"=Analyze this Upwork email and classify it into ONE of these categories:\n\n1. **Job Invitation** - Client invited you to submit a proposal (keywords: \"invited you\", \"submit a proposal\", \"job posting\")\n2. **Interview Request** - Client wants to interview you (keywords: \"interview\", \"would like to chat\", \"schedule a call\")\n3. **Contract Started** - A new contract has begun (keywords: \"contract has started\", \"work has begun\", \"contract is active\")\n4. **Contract Ended** - A contract has been completed/terminated/paused (keywords: \"contract ended\", \"work completed\", \"contract paused\", \"contract terminated\")\n5. **Payment Notification** - Payment received or earnings update (keywords: \"payment\", \"earnings\", \"funds available\", \"deposited\", \"milestone payment\", \"$\" followed by numbers)\n6. **Client Message** - Direct message from a client (keywords: \"sent you a message\", \"new message from\", \"client wrote\")\n7. **Proposal Submitted** - Confirmation of proposal submission (keywords: \"proposal submitted\", \"application sent\")\n8. **Profile View** - Someone viewed your profile (keywords: \"viewed your profile\", \"checked out your profile\")\n9. **Promotional** - Marketing content from Upwork (keywords: \"tips\", \"newsletter\", \"announcement\", \"feature update\")\n10. **Other** - Anything else that doesn't fit above categories\n\nEmail Subject: {{$json[\"subject\"]}}\nEmail Body Preview: {{$json[\"body\"].substring(0, 500)}}...\n\nLook for specific keywords and context clues. For payment emails, look for dollar amounts and words like \"available\", \"deposited\", \"earnings\". For contracts, look for status words like \"started\", \"ended\", \"paused\".\n\nRespond with ONLY the category name (e.g., \"Payment Notification\")."}]},"options":{"temperature":0.1}},"id":"426ed236-fddc-4142-85d2-ce8aab99c1b2","name":"Classify Email1","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1,"position":[-980,180],"credentials":{"openAiApi":{"id":"GfvVBDzqr5JCk9dS","name":"OpenAi account 2"}}},{"parameters":{"jsCode":"// Enhanced data extraction based on email classification\nconst emailData = $items(\"Parse Email Content1\")[0].json;\nconst category = $items(\"Classify Email1\")[0].json.message.content.trim();\nconst body = emailData.body;\nconst subject = emailData.subject;\nconst upworkLinks = emailData.upworkLinks;\n\nlet extractedData = {\n  classification: category,\n  priority: 'Medium',\n  actionRequired: false,\n  extractedInfo: {},\n  relevantLinks: [],\n  summary: ''\n};\n\n// Category-specific data extraction\nswitch (category) {\n  case \"Job Invitation\":\n    extractedData.priority = 'High';\n    extractedData.actionRequired = true;\n    extractedData.relevantLinks = upworkLinks.proposal.concat(upworkLinks.job);\n    \n    // Extract job details\n    const budgetMatch = body.match(/\\$([,\\d]+(?:\\.\\d{2})?)/g);\n    const skillsMatch = body.match(/Skills?:\\s*([^\\n\\r]+)/i);\n    const timelineMatch = body.match(/(\\d+)\\s*(day|week|month)s?/i);\n    \n    extractedData.extractedInfo = {\n      budget: budgetMatch ? budgetMatch[0] : 'Not specified',\n      skills: skillsMatch ? skillsMatch[1].trim() : 'Not specified',\n      timeline: timelineMatch ? timelineMatch[0] : 'Not specified'\n    };\n    extractedData.summary = `New job invitation - Budget: ${extractedData.extractedInfo.budget}`;\n    break;\n    \n  case \"Interview Request\":\n    extractedData.priority = 'High';\n    extractedData.actionRequired = true;\n    extractedData.relevantLinks = upworkLinks.proposal;\n    \n    const clientMatch = body.match(/([A-Z][a-z]+\\s+[A-Z][a-z]+)\\s+would like to interview you/i);\n    extractedData.extractedInfo = {\n      clientName: clientMatch ? clientMatch[1] : 'Not specified'\n    };\n    extractedData.summary = `Interview request from ${extractedData.extractedInfo.clientName}`;\n    break;\n    \n  case \"Payment Notification\":\n    extractedData.priority = 'Medium';\n    extractedData.actionRequired = false;\n    \n    // Better payment detection patterns\n    const earningsMatch = body.match(/\\$([,\\d]+(?:\\.\\d{2})?)/g);\n    const paymentTypeMatch = body.match(/(bonus|milestone|hourly|fixed|payment|earnings|funds)/i);\n    const availableMatch = body.match(/available|deposited|transferred|received/i);\n    \n    extractedData.extractedInfo = {\n      amount: earningsMatch ? earningsMatch[0] : 'Amount not found',\n      type: paymentTypeMatch ? paymentTypeMatch[1] : 'Payment',\n      status: availableMatch ? 'Available' : 'Processed'\n    };\n    extractedData.summary = `Payment notification: ${extractedData.extractedInfo.amount} ${extractedData.extractedInfo.type}`;\n    break;\n    \n  case \"Contract Started\":\n    extractedData.priority = 'High';\n    extractedData.actionRequired = true;\n    extractedData.relevantLinks = upworkLinks.contract;\n    \n    // Better contract title extraction\n    const contractTitleMatch = subject.match(/\"([^\"]+)\"/) || body.match(/contract[:\\s]+([^\\n\\r\\.]+)/i);\n    extractedData.extractedInfo = {\n      contractTitle: contractTitleMatch ? contractTitleMatch[1].trim() : 'Contract title not found'\n    };\n    extractedData.summary = `New contract started: ${extractedData.extractedInfo.contractTitle}`;\n    break;\n    \n  case \"Contract Ended\":\n    extractedData.priority = 'Medium';\n    extractedData.actionRequired = false;\n    extractedData.relevantLinks = upworkLinks.contract;\n    \n    const endedTitleMatch = subject.match(/\"([^\"]+)\"/) || body.match(/contract[:\\s]+([^\\n\\r\\.]+)/i);\n    const endReasonMatch = body.match(/(completed|terminated|paused|cancelled|ended)/i);\n    \n    extractedData.extractedInfo = {\n      contractTitle: endedTitleMatch ? endedTitleMatch[1].trim() : 'Contract title not found',\n      reason: endReasonMatch ? endReasonMatch[1] : 'Not specified'\n    };\n    extractedData.summary = `Contract ${extractedData.extractedInfo.reason}: ${extractedData.extractedInfo.contractTitle}`;\n    break;\n    \n  case \"Client Message\":\n    extractedData.priority = 'High';\n    extractedData.actionRequired = true;\n    \n    const messagePreview = body.substring(0, 100).trim();\n    extractedData.extractedInfo = {\n      preview: messagePreview + (body.length > 100 ? '...' : '')\n    };\n    extractedData.summary = `New client message: ${extractedData.extractedInfo.preview}`;\n    break;\n    \n  case \"Proposal Submitted\":\n    extractedData.priority = 'Low';\n    extractedData.actionRequired = false;\n    extractedData.summary = 'Proposal submission confirmed';\n    break;\n    \n  case \"Profile View\":\n    extractedData.priority = 'Low';\n    extractedData.actionRequired = false;\n    extractedData.summary = 'Someone viewed your profile';\n    break;\n    \n  case \"Promotional\":\n    extractedData.priority = 'Low';\n    extractedData.actionRequired = false;\n    extractedData.summary = 'Promotional content from Upwork';\n    break;\n    \n  default:\n    extractedData.priority = 'Low';\n    extractedData.summary = `Upwork notification: ${category || 'Unclassified'}`;\n}\n\n// Add metadata with corrected structure\nextractedData.processedAt = new Date().toISOString();\nextractedData.emailMetadata = {\n  messageId: emailData.messageId,\n  threadId: emailData.threadId,\n  from: emailData.from,\n  subject: emailData.subject,\n  date: emailData.date,\n  body: emailData.body,\n  bodyPreview: emailData.body ? emailData.body.substring(0, 300) : 'No content available'\n};\n\nreturn [extractedData];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-600,180],"id":"b404e135-f09e-4945-8312-c2832fb72691","name":"Extract Details1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.priority }}","rightValue":"High","operator":{"type":"string","operation":"equals"},"id":"priority-high"},{"leftValue":"={{ $json.classification }}","rightValue":"Job Invitation","operator":{"type":"string","operation":"equals"},"id":"job-invitation"},{"leftValue":"={{ $json.classification }}","rightValue":"Interview Request","operator":{"type":"string","operation":"equals"},"id":"interview-request"},{"leftValue":"={{ $json.classification }}","rightValue":"Contract Started","operator":{"type":"string","operation":"equals"},"id":"contract-started"},{"leftValue":"={{ $json.classification }}","rightValue":"Client Message","operator":{"type":"string","operation":"equals"},"id":"client-message"}],"combinator":"or"}}]},"options":{}},"id":"eb6dad13-3b2a-4095-9d55-854f1b78a0e2","name":"Priority Check2","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-360,180],"alwaysOutputData":true},{"parameters":{"resource":"message","operation":"addLabels"},"id":"eae5ecbd-0797-4648-9c33-8ec3b257bed6","name":"Mark as Low Priority1","type":"n8n-nodes-base.gmail","typeVersion":1,"position":[0,380],"credentials":{"gmailOAuth2":{"id":"XrwBYBoaTlsy2dGw","name":"Gmail account"}}}],"connections":{"Gmail Trigger":{"main":[[{"node":"Get Email Body","type":"main","index":0}]]},"Get Email Body":{"main":[[{"node":"Parse Email Content","type":"main","index":0}]]},"Parse Email Content":{"main":[[{"node":"Classify Email","type":"main","index":0}]]},"Classify Email":{"main":[[{"node":"Extract Details","type":"main","index":0}]]},"Extract Details":{"main":[[]]},"Priority Check":{"main":[[{"node":"Mark as Processed","type":"main","index":0},{"node":"Discord","type":"main","index":0}]]},"Priority Check1":{"main":[[{"node":"Mark as Processed1","type":"main","index":0},{"node":"Discord1","type":"main","index":0},{"node":"Mark as Low Priority","type":"main","index":0}]]},"Gmail Trigger1":{"main":[[{"node":"Get Email Body1","type":"main","index":0}]]},"Get Email Body1":{"main":[[{"node":"Parse Email Content1","type":"main","index":0}]]},"Parse Email Content1":{"main":[[{"node":"Classify Email1","type":"main","index":0}]]},"Classify Email1":{"main":[[{"node":"Extract Details1","type":"main","index":0}]]},"Extract Details1":{"main":[[{"node":"Priority Check2","type":"main","index":0}]]},"Priority Check2":{"main":[[{"node":"Mark as High Priority","type":"main","index":0},{"node":"High Priority Discord Alert","type":"main","index":0},{"node":"Mark as Low Priority1","type":"main","index":0},{"node":"Low Priority Discord Summary","type":"main","index":0}]]}},"pinData":{},"meta":{"templateCredsSetupCompleted":true}}